<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<CSP name="js/controllers/GlobalCtrl.js" application="/workflow/"><![CDATA[
'use strict';

// global controller
// Controls the authentication. Loads the full worklist for user.
function GlobalCtrl( $scope, $location, $cookieStore, $modal, $log, LoginSrvc, TaskSrvc ) {
   $scope.page = {};
   
   $scope.page.alerts = [];

   $scope.page.closeAlert = function( index ) {
     $scope.page.alerts.splice( index, 1 );
   };

   // data initialization for Worklist
   $scope.page.init = function() {    
     // do not need cookie, if we use doLogin()
     if ( $scope.page.loginState !== 1 ) {
       $scope.page.loginState = $cookieStore.get( 'LoginState' );
     }
     
     /* grid data:
        grid title, css grid class, 
        column names, methods
     */
        $scope.page.grid = {
          caption: 'Inbox Tasks',
          cssClass:'table table-bordered table-hover',
          columns: [{name: '', property: 'New'},
                    {name: 'Priority', property: 'Priority'}, 
                    {name: 'Subject', property: 'Subject'},
                    {name: 'Message', property: 'Message'},
                    {name: 'Role', property: 'RoleName'},
                    {name: 'Assigned To', property: 'AssignedTo'},
                    {name: 'Time Created', property: 'TimeCreated'},
                    {name: 'Age', property: 'Age'}],
          edit:    $scope.page.editTask
        };
        
        if ( $scope.page.loginState == 1 ) {
          $scope.page.loadTasks();
        }
   };

   // worklist loading
   $scope.page.loadTasks = function() {
     TaskSrvc.getAll().then(
       function( data ) {
         $scope.page.grid.items = data.children;
       },
       function( data, status, headers, config ) {
         $scope.page.alerts.push( {type: 'danger', msg: 'Tasks are not loaded.'} );  
       });      
   };
   
  // load Task by id
  $scope.page.loadTask = function( id ) {
    TaskSrvc.get(id).then(
      function( data ) {
        $scope.page.task = data;
      },
      function( data, status, headers, config ) {
        $scope.page.alerts.push({type: 'danger', msg: 'Task is not loaded.'});  
      });       
  };
  
  $scope.page.accept = function( selected ) {
    if ( !selected ) 
      return;
    
    TaskSrvc.get( selected.ID ).then(
      function( data ) {
        data.Task["%Action"] = "$Accept";
        $scope.page.submit( data ); 
      },
      function( data, status, headers, config ) {
        $scope.page.alerts.push( {type: 'danger', msg: 'Error during accept.'} );
      });
  };
  
    $scope.page.yield = function( selected ) {
    if ( !selected ) 
      return;
    
    TaskSrvc.get( selected.ID ).then(
      function( data ) {
        data.Task["%Action"] = "$Relinquish";    
        $scope.page.submit( data ); 
      },
      function( data, status, headers, config ) {
        $scope.page.alerts.push( {type: 'danger', msg: 'Error during yield.'} );      
      });
  };
   
  // submit the worklist
  $scope.page.submit = function( worklist ) {
    TaskSrvc.save(worklist).then(
      function( data ) {
        $scope.page.init();
      },
      function( data, status, headers, config ) {
        $scope.page.alerts.push( {type: 'danger', msg: 'Changes not saved.'} );        
      });
  };
   
   // go to single task page
   $scope.page.editTask = function( task ) {
     $location.path( '/workflow/tasks/' + task.ID );
   };
   
   // login function
   $scope.page.doLogin  = function( login, password ) {
     LoginSrvc.auth( login, password ).then(
       function( data ) {
         $scope.page.loginState = 1;   
         document.cookie = "Username=" + data.Username +"; Path=/;"; 
         document.cookie = "LoginState=1; Path=/;"; 
         
         console.log( "Login successful" );
        
         $scope.page.init(); 
       },
       function( data, status, headers, config ) {
         $scope.page.alerts.push( {type: 'danger', msg: 'Log in error!'} ); 
         console.log( "Log in error" );
       });
  };

  // logout function
  $scope.page.doExit = function() {   
    $scope.page.loginState = 0;  
    document.cookie = "Username" + "=; Path=/;";  
    document.cookie = "LoginState" + "=; Path=/;";
    document.cookie = "CSPSESSIONID" + "=; Path=" + DemoSetting+ "; expires=Thu, 01 Jan 1970 00:00:01 GMT;"; 
    document.cookie = "CSPWSERVERID" + "=; Path=" + DemoSetting+ "; expires=Thu, 01 Jan 1970 00:00:01 GMT;";   
  }
  
  // get cookie by name  
  $scope.page.readCookie = function( name ) {
    var nameEQ = name + "=";
    var cookiesArray = document.cookie.split( ';' );
  
    for ( var i = 0; i < cookiesArray.length; i++ ) {
      var cookieElement = cookiesArray[i];
      
      while ( cookieElement.charAt(0) == ' ' ) 
        cookieElement = cookieElement.substring( 1, cookieElement.length );
      
      if ( cookieElement.indexOf(nameEQ) == 0 ) 
        return cookieElement.substring( nameEQ.length, cookieElement.length );
    }
  
    return null;
  };
  
  // Method to get value of any property of the object
  // Example: 
  // var obj = {car: {body: {company: {name: 'Mazda'}}}};
  // getPropertyValue(obj, 'car.body.company.name') 
  $scope.page.getPropertyValue = function( item, propertyStr ) {
    var value = item;

    try {
      var properties = propertyStr.split( '.' );
      for ( var i = 0; i < properties.length; i++ ) {
        value = value[properties[i]];
            
        if ( value !== Object(value) )
          break;
        }
    }
    catch( ex ) {
      console.log( 'Something goes wrong :/' );
    }

    return value == undefined ? '' : value;
  };
  
  
    $scope.page.modalOpen = function (size, id) {
      
      if (!id) return;
      
        TaskSrvc.get( id ).then(
          function( data ) {
            var modalInstance = $modal.open({
              templateUrl: '/workflow/partials/task.csp',
              controller: 'TaskCtrl',
              size: size,
              backdrop: true,
              resolve: {task : function() { return data; } }
            });

            modalInstance.result.then(
              function (selectedItem) {
                $scope.selected = selectedItem;
              }, 
              function () {
                $log.info('Modal dismissed at: ' + new Date());
              });
          },
          function( data, status, headers, config ) {
            $scope.page.alerts.push( {type: 'danger', msg: 'Task not loaded'} );        
          });
       
       };

   
   $scope.page.init(); 
}

// resolving minification problems
GlobalCtrl.$inject = [ '$scope', '$location', '$cookieStore', '$modal', '$log', 'LoginSrvc', 'TaskSrvc' ];
controllersModule.controller( 'GlobalCtrl', GlobalCtrl );
]]></CSP>
</Export>
